<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Friend List</title>
</head>
<body>
<h1>Friend List</h1>
<form action="/custom/users/view/user" method="get">
    <div><input type="submit" value="на главную"/></div>
</form>
<table border="1">
    <form>
        <div><label>Friend name<input type="text" id="friendName"/></label></div>
        <button onclick="addFriend()"> add friend</button>
    </form>
</table>
<h3>Кто пригласил меня</h3>
<table border="1">
    <tr>
        <th>Friend name</th>
    </tr>
    <tr th:each="friend : ${inviters}">
        <td th:text="${friend.user.name}"></td>
        <td>
            <button th:data-id="${friend.id}"
                    th:data-user-inviter-id="${friend.user.id}"
                    th:data-user-id="${friend.friendUser.id}"
                    onclick="accept(this)"> accept</button>

        </td>
        <td>
            <button th:data-id="${friend.id}"
                    onclick="reject(this)"> reject</button>
        </td>
    </tr>
</table>
<h3>Кому я отправил приглашения</h3>
<table border="1">
    <tr>
        <th>Friend name</th>
    </tr>
    <tr th:each="friend : ${sended}">
        <td th:text="${friend.friendUser.name}"></td>
        <td>
            <button th:data-friend-id="${friend.id}" onclick="deleteSendedInvite(this)">delete invite</button>
        </td>
    </tr>
</table>
<h3>My friends</h3>
<table border="1">
    <tr>
        <th>Friend name</th>
    </tr>
    <tr th:each="friend : ${accepted}">
        <td th:text="${friend.friendUser.name}"></td>
        <td>
            <form th:action="@{viewFriend}" method="get" >
                <input type="hidden" name="id" th:value="${friend.user.id}"/>
                <input type="hidden" name="friendId" th:value="${friend.friendUser.id}"/>
                <div><input type="submit" value="view"/></div>
            </form>
        </td>
        <td>
            <button th:data-friend-id="${friend.friendUser.id}" th:data-id="${friend.user.id}"
                    onclick="deleteFriend(this)">delete</button>
        </td>

    </tr>
</table>
</body>
<script>
    function reject(button){
        const id = button.dataset.id

        fetch('/custom/friends/reject', {
               method: 'PUT',
               headers: {
                   'Content-Type': 'application/x-www-form-urlencoded',
               },
               body: `id=${id}`
        })
        .then(response => {
           if (response.ok) {
               window.location.reload();
           } else {
               throw new Error('Ошибка удаления приглашения друга');
           }
        })
    }
    function accept(button){
        const userId = button.dataset.userId
        const userInviterId = button.dataset.userInviterId
        const id = button.dataset.id

        fetch('/custom/friends/accept', {
               method: 'PUT',
               headers: {
                   'Content-Type': 'application/x-www-form-urlencoded',
               },
               body: `id=${id}&userInviterId=${userInviterId}&userId=${userId}`
        })
        .then(response => {
           if (response.ok) {
               window.location.reload();
           } else {
               throw new Error('Ошибка удаления приглашения друга');
           }
        })
    }
    function deleteFriend(button){
        const friendId = button.dataset.friendId
        const id = button.dataset.id
        fetch('/custom/friends/deleteFriend', {
               method: 'DELETE',
               headers: {
                   'Content-Type': 'application/x-www-form-urlencoded',
               },
               body: `id=${id}&friendId=${friendId}`
        })
        .then(response => {
           if (response.ok) {
               window.location.reload();
           } else {
               throw new Error('Ошибка удаления приглашения друга');
           }
        })
    }
    function deleteSendedInvite(button){
        const friendId = button.dataset.friendId
        fetch('/custom/friends/delete', {
               method: 'DELETE',
               headers: {
                   'Content-Type': 'application/x-www-form-urlencoded',
               },
               body: `id=${friendId}`
        })
        .then(response => {
           if (response.ok) {
               window.location.reload();
           } else {
               throw new Error('Ошибка удаления приглашения друга');
           }
        })
    }
    function addFriend(){
        const friendName = document.getElementById('friendName').value.trim();
        fetch('/custom/friends/add', {
               method: 'POST',
               headers: {
                   'Content-Type': 'application/x-www-form-urlencoded',
               },
               body: `friendName=${friendName}`
        })
        .then(response => {
           if (response.ok) {
               alert("friend added")
               window.location.reload();

           } else {
               throw new Error('Ошибка добавления друга');
           }
        })
    }

</script>
</html>